name: Deploy Backend to Render

on:
  push:
    branches: [ main ]
    paths:
      - 'server/**'
      - 'shared/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Trigger Render Deployment
      run: |
        curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
    
    - name: Wait for deployment
      run: sleep 30
    
    - name: Health Check
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.BACKEND_URL }}/health || echo "000")
        if [ "$response" = "200" ] || [ "$response" = "404" ]; then
          echo "✅ Backend is responding"
        else
          echo "⚠️ Backend health check returned: $response"
          exit 1
        fi
    
    - name: Deployment Summary
      run: echo "✅ Backend deployed successfully to Render"
